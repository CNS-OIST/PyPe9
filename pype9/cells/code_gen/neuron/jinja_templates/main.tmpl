{% macro elseif(first) %}{% if first %}if{% else %}} else if{% endif %}{% endmacro %}
:VERBATIM
:extern double nineml_gsl_normal(double, double);
:extern double nineml_gsl_uniform(double, double);
:extern double nineml_gsl_binomial(double, int);
:extern double nineml_gsl_exponential(double);
:extern double nineml_gsl_poisson(double);
:ENDVERBATIM

TITLE Spiking node generated from 9ML using PyPe9 version {{version}} at '{{timestamp}}'

NEURON {
    {%+ if is_subcomponent %}SUFFIX{% else %}POINT_PROCESS{% endif %} {{component.name}}
    
    : T
    RANGE regime_

    :StateVariables:
{% for sv in componentclass.state_variables %}
    RANGE {{sv.name}}
{% endfor %}

    :Parameters
{% for p in componentclass.parameters %}
    RANGE {{p.name}}
{% endfor %}

    :Ports
{% for p in chain(componentclass.analog_receive_ports, componentclass.analog_reduce_ports) %}
    RANGE {{p.name}}
{% endfor %}

    :Aliases
{% for expr in chain(componentclass.aliases, componentclass.piecewises) %}
    RANGE {{expr.lhs}}
{% endfor %}
}

CONSTANT {
    : IDs for regimes, events and conditions 

    : Event flag classes
    EXTERNAL_EVENT_ = 0
    INTERNAL_EVENT_ = 1
    INIT_ = 2

    : Regime flags
{% for regime in componentclass.regimes %}
    {{regime.name | upper}} = {{componentclass.index_of(regime)}}
{% endfor %}

    : Event port flags
{% for port in componentclass.event_receive_ports %}
    {{port.name | upper}} = {{componentclass.index_of(port)}}
{% endfor %}

    : On-condition flags
{% for regime in componentclass.regimes %}
    {% for oc in regime.on_conditions %}
    {# The + 3 is to avoid conflicts with the event classes (i.e. EXTERNAL_EVENT_, INTERNAL_EVENT, INIT_) #}
    {{regime.name | upper}}_COND{{componentclass.index_of(oc, key=regime)}}_ = {{componentclass.index_of(oc) + 3}}
    {% endfor %}
{% endfor %}

}

INITIAL {
    : Initialise State Variables:
{% for sv in componentclass.state_variables %}
    {{sv.name}} = 0
{% endfor %}

    : Initialise Regime:
    {# This should come from the initial state, when we sort out that format #}
    regime_ = {{next(componentclass.regimes).name | upper}}

    : Initialise the NET_RECEIVE block:
    net_send(0, INIT_)
    
    : Active/inactive conditions (conditions transitions are only valid on 
    : triggered from False->True) so check to see if start off False
{% for regime in componentclass.regimes %}
    {% for oc in regime.on_conditions %}
    {{regime.name | lower}}_cond{{componentclass.index_of(oc, key=regime)}}_active = !({{oc.trigger.rhs}})
    {% endfor %}
{% endfor %}

}

PARAMETER {
    : True parameters
{% for p in componentclass.parameters %}
    {{p.name}} = 0
{% endfor %}

    : Constants
{% for c in componentclass.constants %}
    {{c.name}} = {{c.value}} ({{c.units.name}})
{% endfor %}
}

STATE {
{% for sv in componentclass.state_variables if sv.name != 'v' %}
    {{sv.name}}
{% endfor %}
}



ASSIGNED {
    : Internal flags
    regime_
    
    : Active/inactive conditions (conditions transitions are only valid on 
    : triggered from False->True)
{% for regime in componentclass.regimes %}
    {% for oc in regime.on_conditions %}
    {{regime.name | lower}}_cond{{componentclass.index_of(oc, key=regime)}}_active
    {% endfor %}
{% endfor %}

    : Aliases
{% for alias in componentclass.aliases %}
    {{alias.lhs}}
{% endfor %}

    : Weight variables
{% if weight_variables %}
    {% for var in weight_variables.values %}
    {{var}}
    {% endfor %}
{% endif %}
}

BREAKPOINT {
    SOLVE states METHOD {{ode_solver}}
{% for expr in componentclass.required_for(componentclass.all_time_derivatives()).expressions %}
    {{expr.lhs}} = {{expr.rhs}}
{% endfor %}
}

DERIVATIVE states {
{% for sv in componentclass.state_variables %}
    {{sv.name}}' = deriv_{{sv.name}}({{componentclass.required_for(componentclass.all_time_derivatives(sv)).state_variable_names | join(', ')}})
{% endfor %}
}

{% for sv in componentclass.state_variables %}
FUNCTION deriv_{{sv.name}}({{componentclass.required_for(componentclass.all_time_derivatives(sv)).state_variable_names | join(', ')}}) {
    {% for regime in componentclass.regimes %}
    {{elseif(loop.first)}} (regime_ == {{regime.name | upper}}) {
        {% if sv.name in regime.time_derivatives_map %}
        deriv_{{sv.name}} = {{regime.time_derivatives_map[sv.name].rhs}}
        {% else %}
        deriv_{{sv.name}} = 0.0
        {% endif %}
    {% endfor %}
    }
}
{% endfor %}

NET_RECEIVE(w, channel) {
    INITIAL {
      : stop channel being set to 0 by default
    }
    if (flag == INIT_) {
{% for regime in componentclass.regimes %}
    {% for oc in regime.on_conditions %}
        WATCH ({{oc.trigger.rhs}}) 1  : Trigger a transition event
        :WATCH (!({{oc.trigger.rhs}})) 1  : (Re)activate trigger
    {% endfor %}
{% endfor %}
    } else if (flag == EXTERNAL_EVENT_) {
{% for regime in componentclass.regimes %}
        {{elseif(loop.first)}} (regime_ == {{regime.name | upper}}) {
    {% for oe in regime.on_events %}
            {{elseif(loop.first)}} (channel == {{oe.src_port_name | upper}}) {
        {% if weight_variables %}
                {{get_weight_variable}}({{channel}}, {{weight_variables}}) = w
        {% endif %}        
                : Expressions
        {% for expr in componentclass.required_for(oe.state_assignments).expressions %}
            {% if hasasttr(expr, 'pieces') %}  {# Is a Piecewise statement #}
                {% for piece in expr.pieces %}
                {{elseif(loop.first)}} ({{expr.condition}})
                    {{expr_name}} = {{piece.rhs}}
                {% endfor %}
                else
                    {{expr_name}} = {{expr.otherwise.rhs}} 
            {% else %}
                {{expr.lhs}} = {{expr.rhs}}
            {% endif %}
        {% endfor %}
        {% for sa in oe.state_assignments %}
                {{sa.lhs}} = {{sa.rhs}}
        {% endfor %}
        {% for node in oe.event_outputs %}
                {{as_expr}}(node)
        {% endfor %}
            }
    {% endfor %}
{% endfor %}
        }
    } else if (flag == INTERNAL_EVENT_) {
        : Pick up untriaged events emitted by WATCH Block.
        : Re-validate them against Conditions and Regime:
        : Retransmit the correct Transition ID
{% for regime in componentclass.regimes %}
        {{elseif(loop.first)}} (regime_ == {{regime.name | upper}}) {
    {% for oc in regime.on_conditions %}
            if ( {{oc.trigger.rhs}} ) {
                net_send(0, {{regime.name | upper}}_COND{{componentclass.index_of(oc, key=regime)}}_)
                {{regime.name | lower}}_cond{{componentclass.index_of(oc, key=regime)}}_active = 0
            } else {
                {{regime.name | lower}}_cond{{componentclass.index_of(oc, key=regime)}}_active = 1
            }
    {% endfor %}
{% endfor %}
        }
{% for regime in componentclass.regimes %}
    {% for oc in regime.on_conditions %}
    } else if (flag == {{regime.name | upper}}_COND{{componentclass.index_of(oc, key=regime)}}_) {
        regime_ = {{oc.target_regime.name | upper}}
        {% for node in oc.event_outputs %}
        net_event(t)
        {% endfor %}
        {% for sa in oc.state_assignments %}
        {{sa.lhs}}  = {{sa.rhs}}
        {% endfor %}
    {% endfor %}
{% endfor %}
    }
}
