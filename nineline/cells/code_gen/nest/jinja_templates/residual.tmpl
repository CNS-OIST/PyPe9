{# This template sets up residual method required by the IDA solver

   Authors: Ivan Raikov and Thomas G. Close
   Copyright Okinawa Institute of Science and Technology Graudate University 2014
#}
{% if (ode_solver == "ida") %}

//-----------------------------------------------//
// This section was generated from residual.tmpl //
//-----------------------------------------------//
    {% for func_name, _, _ in dynamics %}
extern "C" int {{func_name}}_residual (double t, N_Vector y, N_Vector yp, N_Vector f, void* pnode) {
    int status; 

    // cast the node ptr to an object of the proper type
    assert(pnode);
    {{ModelName}} & vnode =  *(reinterpret_cast<{{ModelName}}*>(pnode));

    N_Vector y1 = vnode.B_.y1;
             
    status = {{func_name}}_dynamics (t, y, y1, pnode);

        {% for i in xrange(num_states) %}
    ITEM(f, {{i}}) = ITEM(y1, {{i}}) - ITEM(yp, {{i}});
        {% endfor %}

    return status;
    {% endfor %}
}
//-------------- residual.tmpl ------------------//
{% endif %}